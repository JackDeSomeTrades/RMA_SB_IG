<robot
  name="backpack_soto_4_0"
  xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- extend xacro functionality with macros of urdf_utils -->
  <xacro:include filename="$(find urdf_utils)/urdf/properties/defaults.xacro" />
  <xacro:include filename="$(find urdf_utils)/urdf/limit.xacro" />
  <xacro:include filename="$(find urdf_utils)/urdf/origin.xacro" />
  <xacro:include filename="$(find urdf_utils)/urdf/parent.xacro" />

  <xacro:include filename="$(find backpack_soto_4_0_description)/urdf/backpack_layer.xacro" />

  <!-- Load default joint data from yaml files in config directory. -->
  <!-- If additional data is present in cman, use it to overwrite the default one. -->
  <xacro:property
      name="cman_config"
      value="${load_cman('backpack_soto_4_0_description', 'backpack_soto_4_0_description.yaml', '')}" />

  <xacro:arg name="standalone" default="false"/>
  <xacro:property name="standalone" value="$(arg standalone)"/>

  <!-- Connection to SOTO -->
  <xacro:unless value="${standalone}">
    <joint
      name="backpack_base_to_base_link"
      type="fixed">
      <origin
        xyz="-0.294 0 0.0885"
        rpy="0 0 0" />
      <parent
        link="base_link" />
      <child
        link="backpack_base_link" />
    </joint>
  </xacro:unless>

  <!-- Start of Layers -->
  <!-- TODO: add support for configurable layer numbers and compartments (needs to be done on pivot_bar link as well) -->
  <xacro:backpack_layer
    layer_index="layer_0"
    left_depth="${cman_config['layer_configuration']['layer_0']['compartment_0']['depth']}"
    right_depth="${cman_config['layer_configuration']['layer_0']['compartment_1']['depth']}"/>
  <xacro:backpack_layer
    layer_index="layer_1"
    left_depth="${cman_config['layer_configuration']['layer_1']['compartment_0']['depth']}"
    right_depth="${cman_config['layer_configuration']['layer_1']['compartment_1']['depth']}"/>
  <xacro:backpack_layer
    layer_index="layer_2"
    left_depth="${cman_config['layer_configuration']['layer_2']['compartment_0']['depth']}"
    double_compartment="false"/>
  <xacro:backpack_layer
    layer_index="layer_3"
    left_depth="${cman_config['layer_configuration']['layer_3']['compartment_0']['depth']}"
    double_compartment="false"/>

  <!-- Add nav_3d_cam_rear -->
  <link name="nav_3d_cam_rear_link" >
    <xacro:point_inertial
      mass="0.018" />
  </link>
  <joint
    name="nav_3d_cam_rear"
    type="fixed">
    <origin
      xyz="-0.9042660093438 -0.00299999999998613 1.81374525650981"
      rpy="-2.50454747661185 5.81433671204338E-13 1.57079632679411" />
    <parent
      link="backpack_base_link" />
    <child
      link="nav_3d_cam_rear_link" />
    <axis
      xyz="0 0 0" />
  </joint>

  <!-- start of Optical frames -->
  <link
    name="nav_3d_cam_rear_depth_optical_frame" />
  <joint
    name="nav_3d_cam_rear_depth_optical"
    type="fixed">
    <xacro:origin_from_config config="${cman_config}" joint_name="nav_3d_cam_rear_depth_optical" />
    <xacro:parent_from_config config="${cman_config}" joint_name="nav_3d_cam_rear_depth_optical" />
    <child
      link="nav_3d_cam_rear_depth_optical_frame" />
  </joint>
  <link
    name="nav_3d_cam_rear_rgb_optical_frame" />
  <joint
    name="nav_3d_cam_rear_rgb_optical"
    type="fixed">
    <xacro:origin_from_config config="${cman_config}" joint_name="nav_3d_cam_rear_rgb_optical" />
    <xacro:parent_from_config config="${cman_config}" joint_name="nav_3d_cam_rear_rgb_optical" />
    <child
      link="nav_3d_cam_rear_rgb_optical_frame" />
  </joint>

  <!-- start of autogenerated component -->
  <link
    name="backpack_base_link">
    <inertial>
      <origin
        xyz="-0.455821265232892 -0.00577757365877395 0.78583802712244"
        rpy="0 0 0" />
      <mass
        value="51.1974466568688" />
      <inertia
        ixx="18.9816299358231"
        ixy="-0.0352688472475744"
        ixz="1.4784509395309"
        iyy="15.0741956264721"
        iyz="-0.279200068260086"
        izz="10.2614463851292" />
    </inertial>
    <visual>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/backpack_base_link.STL" />
      </geometry>
      <material
        name="">
        <color
          rgba="0.752941176470588 0.752941176470588 0.752941176470588 1" />
      </material>
    </visual>
    <collision>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/backpack_base_link.STL" />
      </geometry>
    </collision>
  </link>
  <link
    name="backpack_tilt_link">
    <xacro:point_inertial mass="1" />
  </link>
  <joint
    name="backpack_tilt"
    type="revolute">
    <origin
      xyz="0 0 0"
      rpy="0 0 0" />
    <parent
      link="backpack_base_link" />
    <child
      link="backpack_tilt_link" />
    <axis
      xyz="0 1 0" />
    <xacro:limit_from_config config="${cman_config}" joint_name="backpack_tilt" />
  </joint>
  <link
    name="pivot_bar_link">
    <inertial>
      <origin
        xyz="-1.00259564539407E-10 9.6129575046171E-16 0.710864961391751"
        rpy="0 0 0" />
      <mass
        value="11.549234708381" />
      <inertia
        ixx="2.02376780598256"
        ixy="-3.76524551976487E-14"
        ixz="3.06379251428533E-13"
        iyy="0.166328170735414"
        iyz="-2.72698530423554E-15"
        izz="1.85743963524715" />
    </inertial>
    <visual>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/pivot_bar_link.STL" />
      </geometry>
      <material
        name="">
        <color
          rgba="0.698039215686274 0.698039215686274 0.698039215686274 1" />
      </material>
    </visual>
    <collision>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/pivot_bar_link.STL" />
      </geometry>
    </collision>
  </link>
  <joint
    name="pivot_bar"
    type="prismatic">
    <origin
      xyz="-0.0887264972016103 0 0.147199999999999"
      rpy="0 0 0" />
    <parent
      link="backpack_base_link" />
    <child
      link="pivot_bar_link" />
    <axis
      xyz="0 0 1" />
    <!-- Pivot bar limits aren't autogenerated so we just use backpack_tilt instead -->
    <xacro:limit_from_config config="${cman_config}" joint_name="backpack_tilt" />
    <!-- multiplier based off of small angle approximation using 0.38 m axis offset -->
    <mimic
      joint="backpack_tilt"
      multiplier="-0.38023" />
  </joint>
  <link
    name="backpack_layer_0_link">
    <xacro:point_inertial mass="1" />
  </link>
  <joint
    name="pivot_bar_to_layer_0"
    type="fixed">
    <origin
      xyz="0 0 0.1545"
      rpy="0 0 ${-pi/2}" />
    <parent
      link="pivot_bar_link" />
    <child
      link="backpack_layer_0_link" />
    <axis
      xyz="0 0 0" />
  </joint>
  <link
    name="backpack_layer_1_link">
    <xacro:point_inertial mass="1" />
  </link>
  <joint
    name="pivot_bar_to_layer_1"
    type="fixed">
    <origin
      xyz="0 0 0.5395"
      rpy="0 0 ${-pi/2}" />
    <parent
      link="pivot_bar_link" />
    <child
      link="backpack_layer_1_link" />
    <axis
      xyz="0 0 0" />
  </joint>
  <link
    name="backpack_layer_2_link">
    <xacro:point_inertial mass="1" />
  </link>
  <joint
    name="pivot_bar_to_layer_2"
    type="fixed">
    <origin
      xyz="0 0 0.9245"
      rpy="0 0 ${-pi/2}" />
    <parent
      link="pivot_bar_link" />
    <child
      link="backpack_layer_2_link" />
    <axis
      xyz="0 0 0" />
  </joint>
  <link
    name="backpack_layer_3_link">
    <xacro:point_inertial mass="1" />
  </link>
  <joint
    name="pivot_bar_to_layer_3"
    type="fixed">
    <origin
      xyz="0 0 1.3095"
      rpy="0 0 ${-pi/2}" />
    <parent
      link="pivot_bar_link" />
    <child
      link="backpack_layer_3_link" />
    <axis
      xyz="0 0 0" />
  </joint>

  <link
    name="backpack_light_curtain_emitter_link">
    <inertial>
      <origin
        xyz="-0.0134507091493996 -5.86724921532477E-05 1.27766254949258E-05"
        rpy="0 0 0" />
      <mass
        value="0.639590567420823" />
      <inertia
        ixx="0.03084176"
        ixy="0"
        ixz="0"
        iyy="0.00013446"
        iyz="0"
        izz="0.03082808" />
    </inertial>
    <visual>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/backpack_light_curtain_emitter_link.STL" />
      </geometry>
      <material
        name="">
        <color
          rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
      </material>
    </visual>
    <collision>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/backpack_light_curtain_emitter_link.STL" />
      </geometry>
    </collision>
  </link>
  <joint
    name="backpack_base_to_light_curtain_emitter"
    type="fixed">
    <origin
      xyz="-0.843726497429714 0.000292062117629333 1.81058017879448"
      rpy="3.14159265358979 1.5707963267949 0" />
    <parent
      link="backpack_base_link" />
    <child
      link="backpack_light_curtain_emitter_link" />
    <axis
      xyz="0 0 0" />
  </joint>
  <link
    name="backpack_light_curtain_receiver_link">
    <inertial>
      <origin
        xyz="-0.0134506399940098 0.000460652545142309 1.37200510917923E-05"
        rpy="0 0 0" />
      <mass
        value="0.639593835683053" />
      <inertia
        ixx="0.03084176"
        ixy="0"
        ixz="0"
        iyy="0.00013446"
        iyz="0"
        izz="0.03082808" />
    </inertial>
    <visual>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/backpack_light_curtain_receiver_link.STL" />
      </geometry>
      <material
        name="">
        <color
          rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
      </material>
    </visual>
    <collision>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/backpack_light_curtain_receiver_link.STL" />
      </geometry>
    </collision>
  </link>
  <joint
    name="backpack_base_to_light_curtain_receiver"
    type="fixed">
    <origin
      xyz="-0.84372743857346 0.00130998226353682 0.0849999310700815"
      rpy="0 -1.5707963267949 0" />
    <parent
      link="backpack_base_link" />
    <child
      link="backpack_light_curtain_receiver_link" />
    <axis
      xyz="0 0 0" />
  </joint>

  <link
    name="charger_connector">
    <inertial>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <mass
        value="5" />
      <inertia
        ixx="0.05208333"
        ixy="0"
        ixz="0"
        iyy="0.0262001"
        iyz="0"
        izz="0.0262001" />
    </inertial>
    <visual>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/charger_connector.STL" />
      </geometry>
      <material
        name="">
        <color
          rgba="1 1 1 1" />
      </material>
    </visual>
    <collision>
      <origin
        xyz="0 0 0"
        rpy="0 0 0" />
      <geometry>
        <mesh
          filename="package://backpack_soto_4_0_description/meshes/charger_connector.STL" />
      </geometry>
    </collision>
  </link>

  <joint
    name="backpack_base_to_charger_connector"
    type="fixed">
    <origin
      xyz="-0.359627649604358 0.5109 0.279949443858408"
      rpy="-1.5707963267949 5.14278077834825E-16 1.5707963267949" />
    <parent
      link="backpack_base_link" />
    <child
      link="charger_connector" />
    <axis
      xyz="0 0 0" />
  </joint>
</robot>
